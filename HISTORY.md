

> 启动数据库 
``` sh
sudo ./bin/mongod --replSet test --dbpath ./db/
```


Chiwawaでの、SmartCore側への大きな機能追加は3点。
 1)クラウド・ストレージ化
 2)閲覧権限の追加
 3)非正規化項目の差分同期

お願いしたいことは、3)についてです。(これは正確にはSmartCoreには影響ありません)

(1)MongoDBには結合(join)機能がありません。
故に、正規化した状態でMongoDBに保存していると、検索/ソートができません。
例えば、文書の検索で、検索/ソート条件として登録者の【名前】を指定する場合があります。
そういった要件がある場合は、文書の属性の一部として、登録者のIDと【名前】を入れておきます。(非正規化)
しかし、この場合、ユーザマスタでユーザの名前が変更された場合、非正規化された情報全てをアップデートする必要があります。
マスタを更新した側では、どの情報をアップデートするべきかは分からないので、それをMongoDBが自動的に行う機能(embeddeds機能)を追加します。

(2)もう一つ、Chiwawaでは、階層構造をもつオブジェクトがあり、その階層構造に基づいた権限管理を行いたいという要件があります。
この場合、検索時に、オブジェクトの祖先(ルートオブジェクトに至るまでに経由するオブジェクト全て)を検索対象にします。
階層構造をもつオブジェクトの親に変更があった場合、変更の影響を受ける子オブジェクトの祖先情報を自動的にアップデートする機能(ancestors機能)を追加します。

上記について、MongoDBにトリガ機能があれば問題なかったのですが、そもそもトリガ機能が無いので、
OpLog(ORACLEでいうREDOログ)を監視することでトリガを発生し、上記の両機能を実現しています。

本ソースは以下で管理しています。(パブリック領域なのでGitHubにアカウントがあれば参照できます)
https://github.com/exabugs/MongoTrigger

MongoDBが動作する環境で、start.sh (mongo < trigger.js) を実行すると、トリガ機能が監視を開始します。
testディレクトリのtest.js/test_group.js が自動テストコードになっています。test.sh を実行 (mongo < test.js) するとテストが開始されます。
トリガ機能を停止するには、stop.sh を実行します。


embeddeds機能 は、metadata.embeddeds コレクションに、定義を記載します。
ancestors機能 は、metadata.ancestors コレクションに、定義を記載します。


雷さんにお願いしたいことは、このトリガ機能(embeddes / ancestors 機能) の機能テスト、パフォーマンステスト、環境テスト です。
機能テストは、上記の単体自動テストコードがありますので、もし不足があれば、自動テストコードを追加して欲しいです。
パフォーマンステストは、レコード数が膨大なときに、マスタの更新に遅延が発生しないかどうかを確認して欲しいです。
環境テストでは、MongoDBをレプリケーション / シャーディング した状態で、正常に機能するかどうかを確認して欲しいです。

定義の書き方、テストの内容で不明点があればご連絡下さい。
スケジュール的にはかなり優先度が高く(もし上手くいかない場合は代替手段を考える必要があるため)、来週中には最終的な結果を出したいと思っています。